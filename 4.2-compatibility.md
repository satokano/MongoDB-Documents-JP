<!-- マニュアルっぽいので「ですます」で -->
<!-- 他のマニュアルを参照する場合、どちらかというと英語タイトルそのままで。文章の一部になっていて、訳さないと変な場合は日本語に訳す。 -->
<!-- NOTE: とかの囲みは、QiitaのMDで対応するものがなさそうなので、注意：brなどとしてごまかす？ ```text: かと思ったがそうすると中身のMD記法が解釈されない。divかと思ったがQiitaはstyle属性適用されない。divで囲んでタイトルはstrong、中身は自前でタグを書くのが見た目的には一番マシっぽい。 -->
<!-- SEE ALSO: は参照：、WARNING: は警告： -->
<!-- 英単語・数字の周りに空白をいれるか？ -->
<!-- restの`、``と、Qiita Markdownの対応は？ -->
<!-- credentials 資格情報？ -->
現時点（2019/5）では4.2は未リリースで、4.1系として開発が続けられている状態です。ドキュメントも今後正式リリースまでに変わる可能性があります。変更があった場合は可能な限り追随していく予定です。

------------------------------
# MongoDB 4.2 での互換性の変更

## MMAPv1ストレージエンジンの廃止

MongoDB 4.2では、すでに非推奨であったMMAPv1ストレージエンジンが廃止になりました。

4.0の環境でMMAPv1を使っている場合、4.2にアップグレードする前に[WiredTigerストレージエンジン](https://docs.mongodb.com/master/core/wiredtiger/)に変更しておく必要があります。詳細は以下を参照してください。

- [スタンドアロン環境をWiredTigerに変更する](https://docs.mongodb.com/master/tutorial/change-standalone-wiredtiger/)
- [レプリカセット環境をWiredTigerに変更する](https://docs.mongodb.com/master/tutorial/change-replica-set-wiredtiger/)
- [シャードクラスタ環境をWiredTigerに変更する](https://docs.mongodb.com/master/tutorial/change-sharded-cluster-wiredtiger/)

### MMAPv1に特有の設定オプション

### MMAPv1に特有のパラメータ

以下のMMAPv1に特有のパラメータは廃止されました。

- newCollectionsUsePowerOf2Sizes
- replIndexPrefetch

### MMAPv1に特有のコマンド

MMAPv1に特有のtouchコマンドは廃止されました。

### MMAPv1に特有のコマンドやメソッドのオプション

以下の、MMAPv1に特有のオプションは廃止されました。

- [collMod](https://docs.mongodb.com/master/reference/command/collMod/#dbcmd.collMod)のnoPaddingとusePowerOf2Sizes
- [collStats](https://docs.mongodb.com/master/reference/command/collStats/#dbcmd.collStats)のverbose
- [create](https://docs.mongodb.com/master/reference/command/create/#dbcmd.create)のflags
- [db.createCollection()](https://docs.mongodb.com/master/reference/method/db.createCollection/#db.createCollection)のpaddingFactor、paddingBytes、preservePadding

## 非推奨となっていたコマンドとメソッドの削除

### groupコマンドの削除

バージョン4.2以降では、groupコマンドとその[mongo](https://docs.mongodb.com/master/reference/program/mongo/#bin.mongo)シェルヘルパーのdb.collection.group()は削除されました。3.4からすでに非推奨扱いでした。

代わりに、[db.collection.aggregate()](https://docs.mongodb.com/master/reference/method/db.collection.aggregate/#db.collection.aggregate)と[$group](https://docs.mongodb.com/master/reference/operator/aggregation/group/#pipe._S_group)ステージを使用してください。

### evalコマンドの削除

バージョン4.2以降では、evalコマンドは削除されました。すでに3.0以降で非推奨扱いでした。

バージョン4.2の[mongo](https://docs.mongodb.com/master/reference/program/mongo/#bin.mongo)シェルでの[db.eval()](https://docs.mongodb.com/master/reference/method/db.eval/#db.eval)と[db.collection.copyTo()](https://docs.mongodb.com/master/reference/method/db.collection.copyTo/#db.collection.copyTo)は、MongoDB 4.0かそれ以前のバージョンに接続されている場合のみ実行可能です。

### copydbとcloneの削除

バージョン4.2以降では、すでに非推奨だったcopydbとcloneコマンドは削除されました。

[mongo](https://docs.mongodb.com/master/reference/program/mongo/#bin.mongo)シェルヘルパーのdb.copyDatabase()とdb.cloneDatabase()は、MongoDB 4.0かそれ以前のバージョンに接続されている場合のみ実行可能です。

代替策としては、[mongodump](https://docs.mongodb.com/master/reference/program/mongodump/#bin.mongodump)/[mongorestore](https://docs.mongodb.com/master/reference/program/mongorestore/#bin.mongorestore)か、カスタムスクリプトを用いることができます。

### parallelCollectionScanコマンドの削除

バージョン4.2以降、parallelCollectionScanコマンドは削除されました。

### maxScanの削除

findコマンドのmaxScanオプションと、そのシェルヘルパーであるcursor.maxScanは、すでに非推奨扱いでしたが、削除されました。代わりに、findコマンドのmaxTimeMSオプションか、ヘルパーのcursor.maxTimeMS()を使用してください。

## aggregation

## 一般的な変更点

## MongoDBツール群

### FIPSモード

バージョン4.2以降、--sslFIPSModeオプションは以下のプログラムから削除されました。

- [mongodump](https://docs.mongodb.com/master/reference/program/mongodump/#bin.mongodump)
- [mongoexport](https://docs.mongodb.com/master/reference/program/mongoexport/#bin.mongoexport)
- [mongofiles](https://docs.mongodb.com/master/reference/program/mongofiles/#bin.mongofiles)
- [mongoimport](https://docs.mongodb.com/master/reference/program/mongoimport/#bin.mongoimport)
- [mongorestore](https://docs.mongodb.com/master/reference/program/mongorestore/#bin.mongorestore)
- [mongostat](https://docs.mongodb.com/master/reference/program/mongostat/#bin.mongostat)
- [mongotop](https://docs.mongodb.com/master/reference/program/mongotop/#bin.mongotop)

これらのプログラムは、接続先の[mongod](https://docs.mongodb.com/master/reference/program/mongod/#bin.mongod)/[mongos](https://docs.mongodb.com/master/reference/program/mongos/#bin.mongos)が[FIPSモードを使うように設定されている](https://docs.mongodb.com/master/tutorial/configure-fips/)場合、FIPSモードを使用します。

## 4.2 Feature Compatibility

4.2でのいくつかの機能は、単に4.0のバイナリだけでなく、`featureCompatibilityVersion`を`4.2`に設定することが必要です。
以下の機能が該当します。

- シャードクラスタ環境での[複数ドキュメントトランザクション](https://docs.mongodb.com/master/release-notes/4.2/#txn-sharded-clusters)。

- fCVが4.2以上に設定されているMongoDBにおける、[インデックスキーの制約](https://docs.mongodb.com/master/reference/limits/#Index-Key-Limit)の削除。この制約の削除にともない、[failIndexKeyTooLong](https://docs.mongodb.com/master/reference/parameters/#param.failIndexKeyTooLong)パラメータは、fCVが4.2以上に設定されているMongoDBには影響しないこととなり、MongoDB 2.6から、fCVが"4.0"に設定されているMongoDBまでに適用されることとなります。

- fCVが4.2以上に設定されているMongoDBにおける、[インデックス名の長さ](https://docs.mongodb.com/master/reference/limits/#Index-Name-Length)の制約の削除。

- [ユニークインデックス](https://docs.mongodb.com/master/core/index-unique/)の新しい内部フォーマット。新しいフォーマットは、既存のユニークインデックスにも、新たに作成されたもしくはリビルドされたユニークインデックスにもすべて適用されます。

- MongoDB 4.2以降、$exests: falseと同じ処理として$type: 0を使うことはできなくなりました。nullや空のフィールドを問い合わせる方法は、[こちら](https://docs.mongodb.com/master/tutorial/query-for-null-fields/)を参照してください。
